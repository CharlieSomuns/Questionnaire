<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css">
    <title>问卷管理</title>
</head>

<style>
    .header {
        text-align: center;
        font-size: 1.3em;
        padding: 10px;
        margin-bottom: 20px;
    }

    .question {
        margin-top: 15px;
    }

    .new-question,
    .question {
        border: solid silver 1px;
        padding: 20px;
        position: relative;
    }

    .title,
    .is_checkbox {
        font-size: 1.2em;
    }

    #is_checkbox {
        height: 20px;
        width: 20px;
    }

    input {
        border-radius: 5px;
        border: solid silver 1px;
    }

    input:focus {
        border: solid rgb(11, 143, 148) 1px;
        outline: none;
    }

    .delete {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .save {
        position: absolute;
        top: 10px;
        right: 60px;
    }

    .input-label {
        width: 100px;
    }
    .comment{
        border: solid silver 1px;
        padding: 10px;

    }
</style>

<body onload="load()">
    <div class="header" id="header">

    </div>
    <div class="container" id="comments">
        <div class="row comment">
            <div>${datetime}</div>
            <div>${content}</div>
        </div>
    </div>
    <div style="height:50px">

    </div>
    <div class="container">
        <div class="row">
            <label class="input-label">标题</label>
            <input type="title" id="questionnaire-title">
        </div>
        <div class=" row ">
            <label class="input-label ">数量</label>
            <input type="title" id="questionnaire-quantity">
        </div>
        <div class="row">
            <label class="input-label">截止时间</label>
            <input type="title" id="questionnaire-deadline">
        </div>
    </div>

    <div class="container">
        <div class="row" id="questions">
        </div>
        <div class="row" id="new_questions">
        </div>
        <div style="margin-top: 30px">
            <span class="btn btn-primary" onclick="add_question()">新增问题</span>
        </div>
    </div>
    <div class="container" style="text-align: center;margin-top: 40px;margin-bottom: 150px;">
        <span class="btn btn-info" onclick="save(0)">保存</span>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span class="btn btn-primary" onclick="save(1)">提交审核</span>
    </div>


</body>
<script>
    // 页面对象
    let Page = function () {
        this.start_id = 0
        let that = this
        this.new_questions_container = document.getElementById('new_questions')
        this.questions_container = document.getElementById('questions')
        this.comments_container = document.getElementById('comments')
        this.questions = []
        this.new_question = {
            is_checkbox: false,
            title: '',
            items: []
        }
        this.questionnaire_id = window.sessionStorage.getItem('questionnaire_id')
        this.render_questions = function (questions) {
            let questions_str = ''
            for (let question of questions) {
                let checkbox = "多选"
                if (!question.is_check_box) {
                    checkbox = '单选'
                }
                let select_items = ''
                let question_items = []
                for (let item of question.items) {
                    select_items += `
                    <div class="col-md-4">
                            ${item.content}
                    </div>
                    `
                    question_items.push(`'${item.content}'`)
                }
                let question_str = `
                <div class="question" id="question_${question.id}">
                    <div class="title">
                        <label for="title">${question.title}</label>
                    </div>
                    <div class="is_checkbox">
                        <label for="is_checkbox">${checkbox}</label>
                    </div>
                    <div class="container">
                        <div class="items row" id="items">
                                ${select_items}
                        </div>
                    </div>
                    <span class="save btn btn-sm btn-info" onclick="open_question('${question.id}','${question.title}',${question.is_checkbox},[${question_items}])">
                        <i class="glyphicon glyphicon-pencil"></i>
                    </span>
                    <span class="delete btn btn-sm btn-danger" onclick="delete_question(this,false,${question.id})">
                        <i class="glyphicon glyphicon-remove"></i>
                    </span>
                </div>
                `
                questions_str += question_str
            }
            this.questions_container.innerHTML = questions_str

        }
        this.render_comment = function (data) {
            let comment_str = ''
            for (let comment of data) {
                comment_str += `
                            <div class="row comment">
                                <div>${comment.datetime}</div>
                                <div>${comment.comment}</div>
                            </div>
                    `
            }
            this.comments_container.innerHTML = comment_str
        }
        this.get_comment = function () {
            let that = this
            let xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function (event) {
                let readystate = xhr.readyState
                if (readystate == 4) {
                    if (xhr.status == 200) {
                        let response = JSON.parse(xhr.responseText)
                        let state = response.state
                        let msg = response.msg
                        let data = response.data
                        if (state == 200) {
                            that.render_comment(data)
                        }
                        else {
                            let error_str = ''
                            for (let att in data) {
                                error_str += data[att]
                            }
                            alert(error_str)
                        }
                    }
                }
            }
            xhr.open('get', '/api/v1/questionnaire_comment?questionnaire_id=' + this.questionnaire_id)
            xhr.send()
        }
        this.get_questionnaire = function get_questionnaire() {
            let that = this
            let xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function (event) {
                let readystate = xhr.readyState
                if (readystate == 4) {
                    if (xhr.status == 200) {
                        let response = JSON.parse(xhr.responseText)
                        let state = response.state
                        let msg = response.msg
                        let data = response.data
                        let questionnaire = data[0]
                        that.questionnaire = questionnaire
                        if (state == 200) {
                            document.getElementById('questionnaire-title').value = questionnaire.title
                            document.getElementById('questionnaire-quantity').value = questionnaire.quantity
                            document.getElementById('questionnaire-deadline').value = questionnaire.deadline
                            document.getElementById('header').innerHTML = questionnaire.title
                            that.render_questions(questionnaire.questions)
                            that.get_comment()
                        }
                        else {
                            let error_str = ''
                            for (let att in data) {
                                error_str += data[att]
                            }
                            alert(error_str)
                        }
                    }
                }
            }
            xhr.open('get', '/api/v1/customer_questionnaire?limit=1&start_id=' + (this.questionnaire_id - 1))
            xhr.send(JSON.stringify())
        }
        this.add_question = function () {
            let div = document.createElement('div')
            div.className = "new-question question"
            this.start_id += 1
            div.id = 'new_question_' + this.start_id
            let new_question_str = `
                <div class="title">
                    <label for="title">题纲&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" name="title" id="title">
                </div>
                <div class="is_checkbox">
                    <label for="is_checkbox">多选&nbsp;&nbsp;&nbsp;</label>
                    <input type="checkbox" name="is_checkbox" id="is_checkbox">
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="btn btn-sm btn-primary" onclick="add_item('#new_question_${this.start_id}')">新增选项</span>
                </div>
                <div class="container">
                    <div class="items row" id="items">
                        <div class="col-md-4">
                            <input type="text">
                            <span class="btn btn-xs btn-danger">
                                <i class="glyphicon glyphicon-remove" onclick="this.parentElement.parentElement.remove()"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <span class="save btn btn-sm btn-primary" onclick="put_question(this,true,'#new_question_${this.start_id}')">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span class="delete btn btn-sm btn-danger" onclick="delete_question(this,true,'#new_question_${this.start_id}')">
                    <i class="glyphicon glyphicon-remove"></i>
                </span>
            `
            div.innerHTML = new_question_str
            this.new_questions_container.appendChild(div)

        }
    }
    let page = new Page()
    // 添加问卷表单下的问题选项
    function add_item(id) {
        let div = document.createElement('div')
        div.className = 'col-md-4'
        div.innerHTML = `
                <input type="text">
                <span class="btn btn-xs btn-danger">
                    <i class="glyphicon glyphicon-remove" onclick="this.parentElement.parentElement.remove()"></i>
                </span>
        `
        document.querySelector(id + ' #items').appendChild(div)
    }
    // 打开编辑问卷表单
    function open_question(id, title, is_checkbox, items) {
        console.log(id, title, is_checkbox, items)
        let div = document.getElementById('question_' + id)
        let item_str = ''
        for (let item of items) {
            item_str += `
            <div class="col-md-4">
                <input type="text" value="${item}">
                <span class="btn btn-xs btn-danger">
                    <i class="glyphicon glyphicon-remove" onclick="this.parentElement.parentElement.remove()"></i>
                </span>
            </div>
            `
        }
        let new_question_str = `
                <div class="title">
                    <label for="title">题纲&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" name="title" id="title" value="${title}">
                </div>
                <div class="is_checkbox">
                    <label for="is_checkbox">多选&nbsp;&nbsp;&nbsp;</label>
                    <input type="checkbox" name="is_checkbox" id="is_checkbox">
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="btn btn-sm btn-primary" onclick="add_item('#question_${id}')">新增选项</span>
                </div>
                <div class="container">
                    <div class="items row" id="items">
                       ${item_str}
                    </div>
                </div>

                <span class="save btn btn-sm btn-primary" onclick="post_question(${id})">
                    <i class="glyphicon glyphicon-ok"></i>
                </span>
                <span class="delete btn btn-sm btn-danger" onclick="delete_question(this,true,'#new_question_${this.start_id}')">
                    <i class="glyphicon glyphicon-remove"></i>
                </span>
            `
        div.innerHTML = new_question_str
    }
    // 更新问题
    function post_question(id) {
        let question_id = id
        let title = document.querySelector('#question_' + id + ' #title').value
        let is_checkbox = document.querySelector('#question_' + id + ' #is_checkbox').checked
        let inputs = document.querySelectorAll('#question_' + id + ' #items input')
        let items = []
        for (let input of inputs) {
            items.push(input.value)
        }
        let req_data = {
            question_id: id,
            title: title,
            is_checkbox: is_checkbox,
            items: items
        }
        let xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function () {
            xhr.onreadystatechange = function (event) {
                let readystate = xhr.readyState
                if (readystate == 4) {
                    if (xhr.status == 200) {
                        let response = JSON.parse(xhr.responseText)
                        let state = response.state
                        let msg = response.msg
                        let data = response.data
                        if (state == 200) {
                            page.get_questionnaire()
                        }
                        else {
                            let error_str = ''
                            for (let att in data) {
                                error_str += data[att]
                            }
                            alert(error_str)
                        }
                    }
                }
            }
        }
        xhr.open('post', '/api/v1/customer_question')
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(JSON.stringify(req_data))


    }
    // 新增问题
    function put_question(el, flag, id) {
        let is_checkbox = document.querySelector(id + ' #is_checkbox').checked
        let title = document.querySelector(id + ' #title').value
        let inputs = document.querySelectorAll(id + ' #items input')
        let items = []
        for (let input of inputs) {
            items.push(input.value)
        }
        let req_data = {
            questionnaire_id: page.questionnaire_id,
            title: title,
            is_checkbox: is_checkbox,
            items: items
        }
        let xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function () {
            xhr.onreadystatechange = function (event) {
                let readystate = xhr.readyState
                if (readystate == 4) {
                    if (xhr.status == 200) {
                        let response = JSON.parse(xhr.responseText)
                        let state = response.state
                        let msg = response.msg
                        let data = response.data
                        if (state == 200) {
                            document.querySelector(id).remove()
                            page.get_questionnaire()
                        }
                        else {
                            let error_str = ''
                            for (let att in data) {
                                error_str += data[att]
                            }
                            alert(error_str)
                        }
                    }
                }
            }
        }
        xhr.open('post', '/api/v1/customer_question')
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.setRequestHeader('X-method', 'put')
        xhr.send(JSON.stringify(req_data))
    }
    // 删除问题
    function delete_question(el, flag, id) {
        if (flag) {
            el.parentElement.remove()
        } else {
            console.log('delete question')
            let req_data = {
                ids: [id]
            }
            let xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function () {
                xhr.onreadystatechange = function (event) {
                    let readystate = xhr.readyState
                    if (readystate == 4) {
                        if (xhr.status == 200) {
                            let response = JSON.parse(xhr.responseText)
                            let state = response.state
                            let msg = response.msg
                            let data = response.data
                            if (state == 200) {
                                page.get_questionnaire()
                                alert('删除成功')
                            }
                            else {
                                let error_str = ''
                                for (let att in data) {
                                    error_str += data[att]
                                }
                                alert(error_str)
                            }
                        }
                    }
                }
            }
            xhr.open('post', '/api/v1/customer_question')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.setRequestHeader('X-method', 'delete')
            xhr.send(JSON.stringify(req_data))
        }
        page.get_questionnaire()
    }
    // 保存或者提交审核
    function save(state) {
        let req_data = {
            questionnaire_id: page.questionnaire_id,
            title: document.getElementById('questionnaire-title').value,
            quantity: document.getElementById('questionnaire-quantity').value,
            deadline: document.getElementById('questionnaire-deadline').value,
            state: state,
        }
        let xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function () {
            xhr.onreadystatechange = function (event) {
                let readystate = xhr.readyState
                if (readystate == 4) {
                    if (xhr.status == 200) {
                        let response = JSON.parse(xhr.responseText)
                        let state = response.state
                        let msg = response.msg
                        let data = response.data
                        if (state == 200) {
                            alert('更新成功')
                            page.get_questionnaire()
                        }
                        else {
                            let error_str = ''
                            for (let att in data) {
                                error_str += data[att]
                            }
                            alert(error_str)
                        }
                    }
                }
            }
        }
        xhr.open('post', '/api/v1/customer_questionnaire')
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(JSON.stringify(req_data))

    }
    // 添加问题表单
    function add_question() {
        page.add_question()
    }
    // 页面加载后,获取问卷信息
    function load() {
        page.get_questionnaire()
    }

</script>

</html>